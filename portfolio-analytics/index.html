<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Visitor Analytics</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }

    .stat-card .icon {
      font-size: 2.5rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .stat-card h3 {
      color: #999;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 3rem;
      font-weight: bold;
      color: #333;
      line-height: 1;
    }

    .stat-card .subtext {
      color: #999;
      font-size: 0.85rem;
      margin-top: 10px;
    }

    .controls {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
    }

    .search-box input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button.danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    button.export {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .table-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th {
      padding: 20px 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    td {
      padding: 18px 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: #f8f9ff;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge.mobile {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge.desktop {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .badge.tablet {
      background: #e8f5e9;
      color: #388e3c;
    }

    .no-data {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 1.2rem;
    }

    .no-data i {
      font-size: 4rem;
      color: #ddd;
      margin-bottom: 20px;
      display: block;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .chart-card h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .chart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .chart-item:last-child {
      border-bottom: none;
    }

    .chart-label {
      color: #666;
      font-weight: 500;
    }

    .chart-value {
      color: #667eea;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .last-updated {
      text-align: center;
      color: white;
      margin-top: 20px;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .search-box {
        width: 100%;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
      
      table {
        font-size: 0.85rem;
      }
      
      th, td {
        padding: 12px 8px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> Portfolio Visitor Analytics</h1>
      <p>Track and analyze your portfolio visitors in real-time</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon"><i class="fas fa-users"></i></div>
        <h3>Total Visitors</h3>
        <div class="value" id="totalVisitors">0</div>
        <div class="subtext">All time</div>
      </div>
      
      <div class="stat-card">
        <div class="icon"><i class="fas fa-globe"></i></div>
        <h3>Unique Countries</h3>
        <div class="value" id="uniqueCountries">0</div>
        <div class="subtext">Geographic reach</div>
      </div>
      
      <div class="stat-card">
        <div class="icon"><i class="fas fa-mobile-alt"></i></div>
        <h3>Mobile Visitors</h3>
        <div class="value" id="mobileVisitors">0</div>
        <div class="subtext" id="mobilePercent">0% of total</div>
      </div>
      
      <div class="stat-card">
        <div class="icon"><i class="fas fa-clock"></i></div>
        <h3>Avg. Session Time</h3>
        <div class="value" id="avgSession">0s</div>
        <div class="subtext">Per visitor</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3><i class="fas fa-map-marker-alt"></i> Top Countries</h3>
        <div id="topCountries">
          <div class="no-data">No data yet</div>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-link"></i> Top Referrers</h3>
        <div id="topReferrers">
          <div class="no-data">No data yet</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ðŸ” Search by country, city, browser, IP...">
      </div>
      <button onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button class="export" onclick="exportToCSV()">
        <i class="fas fa-download"></i> Export CSV
      </button>
      <button class="danger" onclick="clearData()">
        <i class="fas fa-trash"></i> Clear Data
      </button>
    </div>

    <!-- Visitors Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Timestamp</th>
            <th>Location</th>
            <th>IP Address</th>
            <th>Device</th>
            <th>Browser</th>
            <th>OS</th>
            <th>Referrer</th>
          </tr>
        </thead>
        <tbody id="visitorsBody">
          <tr>
            <td colspan="8" class="no-data">
              <i class="fas fa-inbox"></i>
              <br>No visitor data available yet
              <br><small>Visitors will appear here once they visit your portfolio</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="last-updated">
      Last updated: <span id="lastUpdated">Never</span> | Auto-refresh every 30 seconds
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: Replace with the SAME config as index.html
    const firebaseConfig = {
      apiKey: "AIzaSyA9yuD1MawPpqius8b-_mG7bcErK4hwQNc",
      authDomain: "portfolio-645a6.firebaseapp.com",
      projectId: "portfolio-645a6",
      storageBucket: "portfolio-645a6.firebasestorage.app",
      messagingSenderId: "225575503296",
      appId: "1:225575503296:web:f4f7746b8feaae4fc73425",
      measurementId: "G-HVQHVTQM49"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global variable to hold visitors for search/filter
    let allVisitors = [];

    // Listen for real-time updates
    function initDashboard() {
      const q = query(collection(db, "portfolio_visitors"), orderBy("timestamp", "desc"), limit(500));
      
      const unsubscribe = onSnapshot(q, (snapshot) => {
        allVisitors = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                ...data,
                // Handle both serverTimestamp (obj) and strings
                timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.clientTimestamp || Date.now())
            };
        });
        
        updateDashboard(allVisitors);
      }, (error) => {
        console.error("Error fetching data: ", error);
        document.querySelector('.table-container').innerHTML = `
            <div class="no-data" style="color: red;">
                <i class="fas fa-exclamation-triangle"></i>
                <br>Error loading data.
                <br><small>Please check your Firebase Configuration in the code.</small>
            </div>`;
      });
    }

    function updateDashboard(visitors) {
      if (visitors.length === 0) {
        document.getElementById('visitorsBody').innerHTML = `
          <tr>
            <td colspan="8" class="no-data">
              <i class="fas fa-inbox"></i>
              <br>No visitor data available yet
            </td>
          </tr>`;
        return;
      }

      updateStatistics(visitors);
      updateCharts(visitors);
      displayVisitors(visitors);
      
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    }

    function displayVisitors(visitors) {
       const tbody = document.getElementById('visitorsBody');
       // Visitors are already sorted by desc timestamp from Firestore query
       tbody.innerHTML = visitors.map((visitor, index) => `
        <tr>
          <td>${visitors.length - index}</td>
          <td>${visitor.timestamp.toLocaleString()}</td>
          <td><i class="fas fa-map-marker-alt"></i> ${visitor.city}, ${visitor.country}</td>
          <td>${visitor.ip}</td>
          <td><span class="badge ${visitor.deviceType?.toLowerCase() || 'desktop'}">${visitor.deviceType || 'Desktop'}</span></td>
          <td><i class="fab fa-${getBrowserIcon(visitor.browser)}"></i> ${visitor.browser} ${visitor.browserVersion}</td>
          <td><i class="fab fa-${getOSIcon(visitor.os)}"></i> ${visitor.os}</td>
          <td>${formatReferrer(visitor.referrer)}</td>
        </tr>
      `).join('');
    }

    // --- Reuse existing UI Helper Functions ---
    // We attach these to window so your existing HTML buttons (onclick="...") can still find them if needed,
    // though for modules using addEventListener is better. I'll patch the existing functions below.

    window.updateStatistics = function(visitors) {
      document.getElementById('totalVisitors').textContent = visitors.length;
      const uniqueCountries = new Set(visitors.map(v => v.country));
      document.getElementById('uniqueCountries').textContent = uniqueCountries.size;
      const mobileCount = visitors.filter(v => v.deviceType === 'Mobile').length;
      const mobilePercent = visitors.length > 0 ? Math.round((mobileCount / visitors.length) * 100) : 0;
      document.getElementById('mobileVisitors').textContent = mobileCount;
      document.getElementById('mobilePercent').textContent = `${mobilePercent}% of total`;
      document.getElementById('avgSession').textContent = '0s'; // Still placeholder
    };

    window.updateCharts = function(visitors) {
       // Top countries
      const countryCounts = {};
      visitors.forEach(v => {
        countryCounts[v.country] = (countryCounts[v.country] || 0) + 1;
      });
      const topCountries = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      
      document.getElementById('topCountries').innerHTML = topCountries.length > 0
        ? topCountries.map(([country, count]) => `
            <div class="chart-item">
              <span class="chart-label">${country}</span>
              <span class="chart-value">${count}</span>
            </div>`).join('')
        : '<div class="no-data">No data yet</div>';

      // Top referrers
      const referrerCounts = {};
      visitors.forEach(v => {
        const ref = (!v.referrer || v.referrer === '' || v.referrer === 'Direct') ? 'Direct' : v.referrer;
        referrerCounts[ref] = (referrerCounts[ref] || 0) + 1;
      });
      const topReferrers = Object.entries(referrerCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      
      document.getElementById('topReferrers').innerHTML = topReferrers.length > 0
        ? topReferrers.map(([referrer, count]) => `
            <div class="chart-item">
              <span class="chart-label">${formatReferrer(referrer)}</span>
              <span class="chart-value">${count}</span>
            </div>`).join('')
        : '<div class="no-data">No data yet</div>';
    };

    window.displayFilteredVisitors = function(visitors) {
        displayVisitors(visitors);
    };

    // --- UI Helpers ---
    window.getBrowserIcon = function(browser) {
      if(!browser) return 'globe';
      const b = browser.toLowerCase();
      if(b.includes('chrome')) return 'chrome';
      if(b.includes('firefox')) return 'firefox';
      if(b.includes('safari')) return 'safari';
      if(b.includes('edge')) return 'edge';
      return 'globe';
    };

    window.getOSIcon = function(os) {
      if(!os) return 'desktop';
      const o = os.toLowerCase();
      if(o.includes('win')) return 'windows';
      if(o.includes('mac') || o.includes('os x')) return 'apple';
      if(o.includes('linux')) return 'linux';
      if(o.includes('android')) return 'android';
      if(o.includes('ios')) return 'apple';
      return 'desktop';
    };

    window.formatReferrer = function(referrer) {
      if (!referrer || referrer === 'Direct') return '<i class="fas fa-arrow-right"></i> Direct';
      if (referrer.includes('linkedin')) return '<i class="fab fa-linkedin"></i> LinkedIn';
      if (referrer.includes('github')) return '<i class="fab fa-github"></i> GitHub';
      if (referrer.includes('google')) return '<i class="fab fa-google"></i> Google';
      if (referrer.includes('facebook')) return '<i class="fab fa-facebook"></i> Facebook';
      if (referrer.includes('twitter')) return '<i class="fab fa-twitter"></i> Twitter';
      try { return '<i class="fas fa-link"></i> ' + new URL(referrer).hostname; } catch(e) { return referrer; }
    };

    // --- Actions ---
    window.refreshData = function() {
        // Since we have a real-time listener, this is mostly visual, but we can re-render
        updateDashboard(allVisitors);
        const btn = document.querySelector('button[onclick="refreshData()"]');
        if(btn) {
             const originalhtml = btn.innerHTML;
             btn.innerHTML = '<i class="fas fa-check"></i> Refreshed!';
             setTimeout(() => btn.innerHTML = originalhtml, 2000);
        }
    };
    
    window.clearData = async function() {
        if (confirm("âš ï¸ ARE YOU SURE? âš ï¸\n\nThis will permanently delete ALL visitor data.\nThis action cannot be undone.")) {
            try {
                const btn = document.querySelector('button[onclick="clearData()"]');
                const originalText = btn ? btn.innerText : 'Clear Data';
                if(btn) btn.innerText = "Deleting...";

                // 1. Get all documents
                const q = query(collection(db, "portfolio_visitors"));
                const snapshot = await getDocs(q);

                // 2. Delete each document
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                alert("All data has been cleared.");
                if(btn) btn.innerText = originalText;
                
                // Dashboard will auto-update via onSnapshot listener
            } catch (error) {
                console.error("Error clearing data:", error);
                alert("Error clearing data: " + error.message);
            }
        }
    };

    window.exportToCSV = function() {
       if (allVisitors.length === 0) { alert('No data to export'); return; }
       const headers = ['Timestamp', 'IP', 'Country', 'City', 'Device', 'Browser', 'OS', 'Referrer'];
       const csvContent = [
        headers.join(','),
        ...allVisitors.map(v => [
          v.timestamp.toISOString(),
          v.ip,
          v.country,
          v.city,
          v.deviceType,
          `${v.browser} ${v.browserVersion}`,
          v.os,
          v.referrer || 'Direct'
        ].join(','))
      ].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `portfolio-visitors-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    };

    // Init Logic
    // Search functionality attached to the DOM element
    const searchInput = document.getElementById('searchInput');
    if(searchInput) {
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = allVisitors.filter(visitor => {
            return (
              (visitor.country || '').toLowerCase().includes(searchTerm) ||
              (visitor.city || '').toLowerCase().includes(searchTerm) ||
              (visitor.browser || '').toLowerCase().includes(searchTerm) ||
              (visitor.os || '').toLowerCase().includes(searchTerm) ||
              (visitor.ip || '').toLowerCase().includes(searchTerm) ||
              (visitor.deviceType || '').toLowerCase().includes(searchTerm)
            );
          });
          displayFilteredVisitors(filtered);
        });
    }

    // Start everything
    initDashboard();

  </script>
</body>
</html>
